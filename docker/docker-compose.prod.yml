# =============================================================================
# AlcheMix Production Docker Compose
# =============================================================================
# Production overrides for docker-compose.yml
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Features:
# - Resource limits for all services
# - Restart policies for reliability
# - Log rotation to prevent disk fill
# - Internal networking (localhost only for external ports)
# - Health checks for all services
#
# Environment Variables Required:
# - JWT_SECRET: 32+ character secret for JWT tokens
# - GEMINI_API_KEY: API key for AI bartender
# - NEO4J_PASSWORD: Password for Neo4j database
# - POSTGRES_PASSWORD: Password for PostgreSQL
# =============================================================================

services:
  # ===========================================================================
  # Neo4j Graph Database (MemMachine backend)
  # ===========================================================================
  neo4j:
    restart: always
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:?NEO4J_PASSWORD is required}
      - NEO4J_dbms_memory_heap_max__size=1500m
      - NEO4J_dbms_memory_pagecache_size=512m
    # Production: Only expose to internal network
    ports: []
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  postgres:
    restart: always
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
    # Production: Only expose to internal network
    ports: []
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # MemMachine Vector Search Service
  # ===========================================================================
  memmachine:
    restart: always
    # Production: Only expose to localhost
    ports:
      - "127.0.0.1:8080:8080"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===========================================================================
  # AlcheMix API Backend
  # ===========================================================================
  api:
    build:
      context: ../api
      dockerfile: Dockerfile
      target: production
    restart: always
    environment:
      - NODE_ENV=production
      - PORT=3000
      - JWT_SECRET=${JWT_SECRET}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - MEMMACHINE_API_URL=http://memmachine:8080
      - MEMMACHINE_ENABLED=true
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3001}
    # Production: Only expose to localhost (use reverse proxy)
    ports:
      - "127.0.0.1:3000:3000"
    volumes:
      - api_data:/app/data
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      postgres:
        condition: service_healthy
      memmachine:
        condition: service_healthy

  # ===========================================================================
  # AlcheMix Frontend
  # ===========================================================================
  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile.prod
    restart: always
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=http://api:3000
    # Production: Only expose to localhost (use reverse proxy)
    ports:
      - "127.0.0.1:3001:3001"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      api:
        condition: service_healthy

# =============================================================================
# Named Volumes
# =============================================================================
volumes:
  api_data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  default:
    driver: bridge
